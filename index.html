<!DOCTYPE html>
<html lang="en">
<!-- 
  SECTION 1: HEAD
  This contains the technical setup, fonts, and the CSS Styling (The Design).
-->
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"/>
  <title>Bookshelf WEB Directory</title>
  
  <!-- IMPORTS: This pulls in the font (Quicksand) and the Slider Library (Swiper) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://unpkg.com">
  <link rel="stylesheet" href="https://unpkg.com/swiper@9/swiper-bundle.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* =========================================
       DESIGN CONTROL PANEL (CHANGE THESE!)
       ========================================= */
    :root {
      /* --- 1. COLOR PALETTE --- */
      --main-text-color: #ffe4f0;       /* Currently Pastel Pink */
      --accent-color:    #ffe4f0;       /* Currently Muted Purple */    /* (changed from #92e7e8) */
      --background-center: #2e2e3a;     /* The lighter middle part of the background */
      --background-edge:   #1a1a20;     /* The dark outer edge of the background */
      
      /* --- 2. GLASS EFFECT SETTINGS --- */
      --glass-opacity:   0.08;          /* Higher = more opaque, Lower = clearer */   /* (changed from 0.08) */
      --glass-blur:      20px;          /* How blurry the background looks through glass */   /* (changed from 10px) */
      --glass-border-color: rgba(255, 255, 255, 0.853);     /* changed from : rgba(255, 255, 255, 0.15) */
      
      /* --- 3. BOOK PLATE (The rectangle behind the book) --- */
      --plate-bg-color:  rgba(255, 255, 255, 0.05);
      --plate-border-radius: 6px;       /* Roundness of the plate corners */    /* (changed from 4px) */
      --plate-padding:   12px;          /* Space between the image and the glass edge */
      
      /* --- 4. SIZES & FONTS --- */
      --main-font: 'Quicksand', sans-serif;
      --menu-width: 380px;              /* How wide the side menu is */
      
      /* --- 5. ANIMATION SPEEDS --- */
      --bounce-effect: cubic-bezier(0.25, 1.2, 0.5, 1.15); /* The "bouncy" feeling */

      /* --- 6. ACTIVE GLOW / RIM SETTINGS (NEW TOGGLES) --- */
      --active-highlight-color: rgba(255, 228, 240, 0.8);     /* This is the color of the glow and the highlight rim border */
      --active-glow-intensity: 7px;       /* How far the glow spreads. Increase this for a bigger aura. */
      --active-glow-opacity: 0.1;       /* How visible the glow is (0.0 to 1.0). Increase for a stronger light. */
    }

    /* =========================================
       CORE LAYOUT (The Skeleton)
       ========================================= */
    body { 
      margin: 0; padding: 0; 
      /* Uses the colors defined in the Control Panel above */
      background: radial-gradient(circle at 50% 30%, var(--background-center) 0%, var(--background-edge) 80%);
      font-family: var(--main-font); 
      color: var(--main-text-color); 
      overflow: hidden; /* Prevents scrollbars on the main page */
      height: 100vh;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    /* The glowing light in the center of the screen */
    .ambient-light {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 100vw; height: 60vh;
      background: radial-gradient(ellipse at center, rgba(122, 127, 197, 0.1) 0%, transparent 70%);
      pointer-events: none; z-index: 0;
    }

    /* =========================================
       UI ELEMENTS (Dropdown & Buttons)
       ========================================= */
    
    /* The Shelf Selector Dropdown (Top Left) */
    #shelfSelectWrapper {
      position: fixed; top: max(20px, env(safe-area-inset-top, 20px)); left: 20px; z-index: 100;
      pointer-events: none;
    }
    #shelfSelect { 
      pointer-events: auto; appearance: none; padding: 10px 20px 10px 16px;
      font-size: 1rem; font-weight: 600; color: var(--accent-color);
      background: rgba(255, 255, 255, var(--glass-opacity)); 
      backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur));
      border: 1px solid var(--glass-border-color); border-radius: 12px;
      box-shadow: 0 0px 15px rgba(0,0,0,0.2); cursor: pointer; outline: none; text-align: center;  /* box-shadow changed from 0 4px 15px */
    }

    /* The "IRL Layout" Button (Top Right) */
    #menuToggle {
      position: fixed; top: max(20px, env(safe-area-inset-top, 20px)); right: 20px; z-index: 1200;
      background: var(--main-text-color); color: rgba(30, 30, 35, 0.9);
      border: none; border-radius: 12px; padding: 10px 18px;
      box-shadow: 0 0px 20px rgba(255, 228, 240, 0.3);  /* "box-shadow" is the setting for the "IRL layout" button's glow offset */
      cursor: pointer; font-weight: 700; font-size: 0.9rem;
    }

    /* =========================================
       THE CAROUSEL (Swiper Settings)
       ========================================= */
    .swiper { width: 100%; height: 75vh; padding-top: 20px; padding-bottom: 20px; z-index: 10; }
    .swiper-wrapper { align-items: center; }

    /* The Container for a single book */
    .swiper-slide {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      transition: opacity 0.4s ease; 
      opacity: 0.4; /* Inactive slides are faded out */
    }
    
    /* The Slide currently in the center */
    .swiper-slide-active { opacity: 1; z-index: 50; }

    /* THE GLASS PLATE BEHIND THE BOOK */
    .book-display {
      position: relative;
      background: var(--plate-bg-color);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: var(--plate-border-radius);
      padding: var(--plate-padding);
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
      transition: all 0.5s var(--bounce-effect);
      display: flex; align-items: center; justify-content: center;
    }

    .book-display img {
      display: block;
      border-radius: 2px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    /* GLOW EFFECT when a book is active */
    .swiper-slide-active .book-display {
      background: rgba(255, 255, 255, 0.12); /* Slightly brighter plate */
      border: 1px solid rgba(255, 228, 240, 0.6);      /* The Highlight Rim Border */
      box-shadow:       /* The Glow Effect (multiple shadows combined) */
        0 20px 50px rgba(0,0,0,0.5),   /* Standard drop shadow */
        0 0 var(--active-glow-intensity) var(--active-glow-intensity) rgba(255, 228, 240, var(--active-glow-opacity)), /* THE MAIN GLOW */
        inset 0 0 20px rgba(255, 255, 255, 0.05);  /* Inner gloss */
    }

    /* =========================================
       RESPONSIVE SIZING (Mobile vs Desktop)
       ========================================= */

    /* DESKTOP MODE: Fixed Height, Flexible Width */
    .swiper-slide { height: 55vh; width: auto; }
    .book-display { height: 100%; width: auto; }
    .book-display img { height: 100%; width: auto; }

    /* MOBILE MODE: Fixed Width, Flexible Height */
    @media (orientation: portrait) {
      .swiper-slide { width: 70vw; height: auto; }
      .book-display { width: 100%; height: auto; box-sizing: border-box; }
      .book-display img { width: 100%; height: auto; }
    }

    /* The Text Caption below the book */
    .swiper-slide p { 
      margin-top: 25px; 
      font-size: 0.9rem; color: var(--main-text-color); font-weight: 600; text-align: center;
      background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(5px);
      border-radius: 6px; padding: 8px 12px;
      max-width: 90%;
      opacity: 0; transform: translateY(10px);
      transition: all 0.4s ease;
    }
    .swiper-slide-active p { opacity: 1; transform: translateY(0); color: #fff; }

    /* Arrows */
    .swiper-button-next, .swiper-button-prev { 
      color: var(--main-text-color); opacity: 0.3; background: rgba(255,255,255,0.08);
      backdrop-filter: blur(3px); border-radius: 50%; width: 44px; height: 44px;
    }
    .swiper-button-next:hover, .swiper-button-prev:hover { color: var(--background-edge); opacity: 1; background: var(--main-text-color); }
    .swiper-button-next:after, .swiper-button-prev:after { font-size: 1rem; font-weight: bold; }

    /* Scrollbar (The dots at the bottom) */
    .swiper-scrollbar { bottom: 20px; background: none; height: 10px; width: 80%; }
    .swiper-scrollbar-drag { background: none; height: 10px; position: relative; }
    .swiper-scrollbar-drag:after {
      content: ""; width: 10px; height: 10px; border-radius: 50%; 
      background: var(--main-text-color); 
      position: absolute; top: 0; left: 50%; margin: 0 0 0 -5px; 
      box-shadow: 0 0 5px var(--main-text-color);
    }

    /* =========================================
       SIDE MENU STYLES
       ========================================= */
    #slideMenu {
      position: fixed; top: 0; right: 0; bottom: 0; width: var(--menu-width); max-width: 90%;
      background: rgba(30, 30, 35, 0.9); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
      border-left: 1px solid var(--glass-border-color); 
      transform: translateX(110%); /* Hidden by default */
      transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
      z-index: 1100; padding: calc(20px + env(safe-area-inset-top)) 25px calc(20px + env(safe-area-inset-bottom));
      display: flex; flex-direction: column; gap: 20px;
    }
    #slideMenu.open { transform: translateX(0); } /* Visible */

    .menu-header { color: var(--main-text-color); font-size: 1.2rem; font-weight: 700; display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; }
    #menuClose { background: none; border: none; color: var(--main-text-color); font-size: 1.5rem; cursor: pointer; }
    
    .menu-grid { display: grid; grid-template-columns: 1fr 1fr; grid-auto-rows: 90px; gap: 12px; overflow-y: auto; flex: 1; padding-right: 5px; }
    .grid-cell { width: 100%; display: flex; }
    .split-horizontal { display: flex; flex-direction: row; gap: 8px; width: 100%; }
    .split-vertical { display: flex; flex-direction: column; gap: 8px; width: 100%; height: 100%; }
    
    .menu-btn { 
      flex: 1; display: flex; align-items: center; justify-content: center; text-align: center; 
      font-size: 0.85rem; padding: 10px; border-radius: 12px; 
      border: 1px solid var(--glass-border-color); background: rgba(255,255,255,0.08); color: var(--main-text-color); 
      cursor: pointer; transition: all 0.2s; 
    }
    .menu-btn:hover:not(.disabled) { transform: translateY(-2px); background: rgba(255,255,255,0.1); color: #fff; }
    .menu-btn.disabled { opacity: 0.3; cursor: not-allowed; filter: grayscale(1); }
    .hidden-btn { display: none !important; }

    .menu-bottom { margin-top: auto; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: space-between; }
    
    /* The Toggle Switch in the menu */
    .switch { position: relative; display: inline-block; width: 46px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #3a3a45; transition: .4s; border-radius: 34px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: var(--main-text-color); transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); background-color: #fff; }
    
    #menuOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.45); opacity: 0; pointer-events: none; transition: opacity .25s; z-index: 1050; }
    #menuOverlay.visible { opacity: 1; pointer-events: auto; }
    
    @media (max-width: 480px) {
      .menu-grid { grid-template-columns: 1fr; grid-auto-rows: 80px; } 
      .split-horizontal { flex-direction: column; }
    }
  </style>
</head>

<!-- 
  SECTION 2: BODY
  The visual elements that appear on the screen.
-->
<body>

  <!-- Background Light Glow -->
  <div class="ambient-light"></div>

  <!-- Top Left: Shelf Dropdown -->
  <div id="shelfSelectWrapper">
    <select id="shelfSelect" aria-label="Select shelf"><option>Loading...</option></select>
  </div>

  <!-- Center: The Swiper Carousel -->
  <div class="swiper">
    <div class="swiper-wrapper" id="slides"></div>
    <div class="swiper-button-prev"></div>
    <div class="swiper-button-next"></div>
    <div class="swiper-scrollbar"></div>
  </div>

  <!-- Top Right: Menu Button -->
  <button id="menuToggle" aria-expanded="false">IRL Layout</button>
  <div id="menuOverlay"></div>

  <!-- Side Menu (Slide-out) -->
  <aside id="slideMenu" aria-hidden="true">
    <div class="menu-header"><span>IRL Layout</span><button id="menuClose">âœ•</button></div>
    <div class="menu-grid" id="menuGrid"></div>
    <div class="menu-bottom">
      <div style="font-size:0.9rem; color:var(--main-text-color);">
        <strong>H-Shelves</strong><br><span style="font-size:0.8rem; color:#aaa">Toggle H shelves visibility</span>
      </div>
      <label class="switch"><input type="checkbox" id="hShelfToggle"><span class="slider"></span></label>
    </div>
  </aside>

  <!-- 
    SECTION 3: JAVASCRIPT
    The logic: loading data, handling passwords, and making the slider move.
  -->
  <script src="https://unpkg.com/swiper@9/swiper-bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>

  <script>
    /* --- CONFIGURATION --- */
    // This is the Google Script that holds your library data
    const DATA_ENDPOINT = 'https://script.google.com/macros/s/AKfycbyg80aRLrhXUo7Lsnjv3YreDnuwS2I3Lf2o3G3KHiDOXP4pBg_z7gUYwDo9CCoIacqUKA/exec';
    
    // These names must match your Google Sheet exactly to work with the toggle
    const H_SHELF_NAMES = ['H shelf L BKS', 'H shelf R BKS'];

    /* --- STATE VARIABLES --- */
    let swiperInstance = null;
    window._shelvesData = [];
    window._menuButtons = []; 

    // 1. Initialize the App
    async function init() {
      // Step A: Ask for password
      const password = prompt("Enter decryption password, loading takes ~6sec");
      const padded_pw = password + "___________";

      const sel = document.getElementById('shelfSelect');
      sel.innerHTML = '<option disabled selected>Loading...</option>';

      try {
        // Step B: Fetch Data from Google
        const resp = await fetch(DATA_ENDPOINT);
        if (!resp.ok) throw new Error(resp.statusText);
        const text = (await resp.text()).trim();
        let data = null;

        // Step C: Decrypt the data
        if (text.startsWith('{') || text.startsWith('[')) {
           // If it's not encrypted (starts with bracket), just load it
           data = JSON.parse(text);
        } else {
           // If it IS encrypted, unlock it
           if (!password) throw new Error('Password required.');
           const key = CryptoJS.enc.Utf8.parse(padded_pw);
           const iv  = CryptoJS.enc.Utf8.parse("0000000000000000");
           const bytes = CryptoJS.AES.decrypt(text, key, { iv: iv, mode: CryptoJS.mode.CBC, padding: CryptoJS.pad.Pkcs7 });
           const plain = bytes.toString(CryptoJS.enc.Utf8);
           if (!plain) throw new Error('Bad password.');
           data = JSON.parse(plain);
        }

        if (Array.isArray(data)) {
          window._shelvesData = data;
          populateApp();
        } else { alert('Data format incorrect.'); }
      } catch (err) {
        alert('Error: ' + err.message);
        sel.innerHTML = '<option disabled selected>Error</option>';
      }
    }
    
    // 2. Build the UI after data is loaded
    function populateApp() {
      buildMenuButtons();
      refreshUI();
    }

    // Helper: Find shelf index by name
    function findShelvesByKeyword(keyword, count = 1, reserved = new Set()){
      const words = (keyword||'').toLowerCase().split(/\s+/).filter(Boolean);
      const results = [];
      const data = window._shelvesData || [];
      for (let i=0; i<data.length && results.length < count; i++){
          if (reserved.has(i)) continue;
          const name = (data[i] && data[i].shelf) ? data[i].shelf.toLowerCase() : '';
          let ok = true;
          for (const w of words){ if (!name.includes(w)) { ok = false; break; } }
          if (ok) results.push(i);
      }
      return results;
    }
    
    function findIndexForLabel(label, fuzzyKeyword, reserveSet){
        const found = findShelvesByKeyword(fuzzyKeyword || label, 1, reserveSet);
        if (found && found.length) return found[0];
        for (let j=0;j<window._shelvesData.length;j++) if (!reserveSet.has(j)) return j;
        return undefined;
    }

    // 3. Update the Dropdown list based on the Toggle
    function refreshUI() {
      const showH = document.getElementById('hShelfToggle').checked;
      const sel = document.getElementById('shelfSelect');
      const previousValue = sel.value; 
      sel.innerHTML = '';

      const shelves = window._shelvesData || [];
      const visible = shelves.map((s, idx) => ({s, idx})).filter(({s}) => {
        if (!s || !s.shelf) return false;
        // If toggle is OFF and shelf is in the restricted list, hide it
        if (!showH && H_SHELF_NAMES.includes(s.shelf)) return false;
        return true;
      });

      if (visible.length === 0) {
        sel.innerHTML = '<option disabled selected>No shelves visible</option>';
        renderSlides([]);
        return;
      }

      visible.forEach(({s, idx}) => {
        const opt = document.createElement('option');
        opt.value = idx;
        opt.text = (s.shelf || `Shelf ${idx+1}`).replace(' BKS', ''); 
        sel.appendChild(opt);
      });

      let shouldReRender = true;
      const isPreviousStillValid = Array.from(sel.options).some(o => o.value === previousValue);

      if (previousValue && isPreviousStillValid) {
        sel.value = previousValue;
        shouldReRender = false; 
      } else {
        sel.value = sel.options[0].value;
        shouldReRender = true;
      }

      sel.onchange = () => {
        const idx = Number(sel.value);
        const items = (window._shelvesData[idx]?.items) || [];
        renderSlides(items);
      };

      if (shouldReRender) sel.onchange();
      updateMenuState(showH);
    }

    // 4. Gray out buttons in the menu if hidden
    function updateMenuState(showH) {
      window._menuButtons.forEach(obj => {
        const btn = obj.element;
        if (H_SHELF_NAMES.includes(obj.shelfName)) {
          if (showH) {
            btn.classList.remove('hidden-btn', 'disabled');
            btn.removeAttribute('aria-disabled');
          } else {
            btn.classList.add('hidden-btn', 'disabled');
            btn.setAttribute('aria-disabled','true');
          }
        }
      });
    }

    // 5. Generate the Grid Buttons in the Side Menu
    function buildMenuButtons() {
      const grid = document.getElementById('menuGrid');
      grid.innerHTML = '';
      window._menuButtons = [];
      const shelves = window._shelvesData;
      const reserved = new Set();
      
      const makeBtn = (label, keywords) => {
        const idx = findIndexForLabel(label, keywords, reserved);
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'menu-btn';
        btn.innerText = label;
        let sName = '';
        if (typeof idx === 'number') {
          reserved.add(idx);
          sName = shelves[idx].shelf;
          btn.setAttribute('data-idx', String(idx));
          btn.onclick = () => {
            const sel = document.getElementById('shelfSelect');
            const targetOption = Array.from(sel.options).find(o => Number(o.value) === idx);
            if (targetOption) { sel.value = idx; sel.onchange(); closeMenu(); } 
            else { alert("Please toggle 'H-Shelves' visibility."); }
          };
        } else {
          btn.classList.add('disabled');
          btn.setAttribute('aria-disabled','true');
        }
        window._menuButtons.push({ element: btn, shelfName: sName });
        return btn;
      };

      /* MENU LAYOUT CONFIGURATION
         This array determines what buttons appear in the menu.
         [ ] = Empty space
         [{label: "Name"}] = A button
      */
      const gridLayout = [
        [{ label: 'Glass Display', keyword: 'glass display' }], [], 
        [{ label: 'Cupboard Back', keyword: 'wooden cupboard back' }, { label: 'Cupboard Front', keyword: 'wooden cupboard front', isVertical: true }], 
        [{ label: 'Display Shelf', keyword: 'display shelf' }], 
        [{ label: 'H Shelf L', keyword: 'H shelf L' }, { label: 'H Shelf R', keyword: 'H shelf R' }], 
        [{ label: 'Cupboard L', keyword: 'display cupboard L' }, { label: 'Cupboard R', keyword: 'display cupboard R' }],
        [{ label: 'Cupboard Ground', keyword: 'Wooden cupboard bottom' }], []
      ];
      
      gridLayout.forEach((cellContent) => {
          const cell = document.createElement('div'); cell.className='grid-cell';
          const hasVertical = cellContent.some(x => x.isVertical);
          if (cellContent.length === 1) {
              cell.appendChild(makeBtn(cellContent[0].label, cellContent[0].keyword));
          } else if (cellContent.length > 1) {
              const wrapper = document.createElement('div');
              wrapper.className = hasVertical ? 'split-vertical' : 'split-horizontal';
              cellContent.forEach(item => wrapper.appendChild(makeBtn(item.label, item.keyword)));
              cell.appendChild(wrapper);
          }
          grid.appendChild(cell);
      });
    }

    // 6. Create the Slides (Books)
    function renderSlides(items) {
      const container = document.getElementById('slides');
      container.innerHTML = '';

      if (items.length === 0) {
        container.innerHTML = `<div class="swiper-slide"><p>No items.</p></div>`;
      } else {
        items.forEach(i => {
          const slide = document.createElement('div');
          slide.className = 'swiper-slide';
          slide.innerHTML = `
            <div class="book-display">
                <img src="${i.cover || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" 
                     alt="${i.title}" 
                     loading="lazy"
                     onerror="this.onerror=null;this.src='https://placehold.co/280x380/303030/999999?text=Cover+Not+Found'">
            </div>
            <p>${i.title || 'Untitled'}</p>
          `;
          container.appendChild(slide);
        });
      }

      if (swiperInstance) { swiperInstance.destroy(true, true); swiperInstance = null; }

      // 7. Initialize Swiper (The Carousel Logic)
      swiperInstance = new Swiper('.swiper', {
        effect: "coverflow",
        grabCursor: true,
        centeredSlides: true,
        centerInsufficientSlides: true,
        slidesPerView: "auto",
        spaceBetween: 40, // Space between books
        freeMode: {
          enabled: true,
          momentum: true,          
          momentumRatio: 1,        
          momentumBounce: false,   
          sticky: true,            
        },
        roundLengths: true, 
        coverflowEffect: {
          rotate: 15, // Rotation of side books
          stretch: 0,
          depth: 100, // Depth perception
          modifier: 1,
          scale: 0.9, 
          slideShadows: false, 
        },
        navigation: { nextEl: '.swiper-button-next', prevEl: '.swiper-button-prev' },
        scrollbar: { el: ".swiper-scrollbar", draggable: true, snapOnRelease: true },
        mousewheel: { forceToAxis: true },
        keyboard: true
      });
    }

    /* UI Event Listeners (Clicks & Scrolls) */
    const menuToggle = document.getElementById('menuToggle');
    const menu = document.getElementById('slideMenu');
    const overlay = document.getElementById('menuOverlay');
    const closeBtn = document.getElementById('menuClose');
    const hToggle = document.getElementById('hShelfToggle');

    function openMenu(){ menu.classList.add('open'); menu.setAttribute('aria-hidden','false'); menuToggle.setAttribute('aria-expanded','true'); overlay.classList.add('visible'); }
    function closeMenu(){ menu.classList.remove('open'); menu.setAttribute('aria-hidden','true'); menuToggle.setAttribute('aria-expanded','false'); overlay.classList.remove('visible'); }

    menuToggle.onclick = () => menu.classList.contains('open') ? closeMenu() : openMenu();
    closeBtn.onclick = closeMenu;
    overlay.onclick = closeMenu;
    hToggle.checked = false;
    hToggle.onchange = () => refreshUI();

    const ALLOW = ['.swiper', '#slideMenu', '.swiper-scrollbar'];
    function preventScroll(e) { if (ALLOW.some(sel => e.target.closest(sel))) return; e.preventDefault(); }
    window.addEventListener('touchmove', preventScroll, {passive: false});
    window.addEventListener('wheel', preventScroll, {passive: false});

    // Start everything
    init();
  </script>
</body>
</html>
